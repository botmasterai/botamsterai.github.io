<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  
  <link rel="shortcut icon" href="../../images/favicon.ico" type="image/x-icon" />

  <title>Botmaster | Socket.io Setup</title>
  <link rel="stylesheet" href="../../css/tachyons.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link rel="stylesheet" href="../../css/notices.css" />
  <link rel="stylesheet" href="../../css/base16-tomorrow.light.css" />
  <link href="../../css/botmaster_style.css" rel="stylesheet">

</head>

<body>

<nav class="container center pa4 mb3">
  <div class="fl w-80 w-100-l">
    <a href="../../">
      <img class="v-mid" src="../../img/botmaster_light.svg" width="200" />
    </a>
  </div>
  <div class="fl w-20 tr dn-l f1 dusty-gray" onclick="showNavMenu()">
    &#9776;
  </div>
</nav>
<main class="container center">
  <div id="sidebar" class="fl w-100 w-20-l pr1-l dn di-l">
  <ul class="list mv2 ml4 ma2-l pa0">
    
      <h5 class="dusty-gray mt3 mb3 ttu">Documentation</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../documentation/botmaster/">
            Botmaster
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Getting Started</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/installation/">
            Installation
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/quickstart/">
            Quickstart
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/messenger-setup/">
            Messenger setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/slack-setup/">
            Slack setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/twitter-setup/">
            Twitter setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/telegram-setup/">
            Telegram setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/socketio-setup/">
            Socketio setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/webhooks/">
            Webhooks
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Working with Botmaster</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../working-with-botmaster/botmaster-basics/">
            Botmaster Basics
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../working-with-botmaster/middleware/">
            Middleware
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../working-with-botmaster/writing-your-own-bot-class/">
            Writing your own Bot Class
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Middlewares</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../middlewares/official-middleware/">
            Official Middleware
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../middlewares/fulfill/">
            Fulfill
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Tutorials</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../tutorials/watson-conversation/">
            Watson Conversation
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../tutorials/using-fulfill/">
            Using Fulfill
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Articles</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../articles/frameworks-comparison/">
            Frameworks comparison
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Updates</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../updates/changelog/">
            Changelog
          </a>
        </li>
      
    
  </ul>
</div>

  <div class="fl w-80-l w-100 pl2-l">
    <div class="bg-white br2 mt3">
      <div class="tc bg-black-pearl pv4 br--top2">
        <h1 class="fw5 white">Socket.io Setup</h1>
      </div>
      <div class="pa4">

<h2 id="code">Code</h2>

<h4 id="server">Server</h4>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">const</span> <span class="nx">Botmaster</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;botmaster&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">botmaster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Botmaster</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">socketioSettings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;SOME_BOT_ID_OF_YOUR_CHOOSING&#39;</span><span class="p">,</span>
  <span class="nx">server</span><span class="o">:</span> <span class="nx">botmaster</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="c1">// this is required for socket.io. You can set it to another node server object if you wish to. But in this example, we will use the one created by botmaster under the hood</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">socketioBot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Botmaster</span><span class="p">.</span><span class="nx">botTypes</span><span class="p">.</span><span class="nx">SocketioBot</span><span class="p">(</span><span class="nx">socketioSettings</span><span class="p">);</span>
<span class="nx">botmaster</span><span class="p">.</span><span class="nx">addBot</span><span class="p">(</span><span class="nx">socketioBot</span><span class="p">);</span>

<span class="nx">botmaster</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="s1">&#39;Right back at you&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>

<h4 id="client">Client</h4>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">const</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io-client&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="s1">&#39;ws://localhost:3000&#39;</span><span class="p">);</span>

<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Hey there botmaster!&#39;</span>
  <span class="p">};</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>

<h2 id="the-botmaster-socket-io-bot">The Botmaster Socket.io bot</h2>

<p>Socket.io is a great library that allows developers to write apps using webSockets (with fallbacks to http long-polling and others when webSockets aren&rsquo;t available on the client). You can read more about it on their own website here: <a href="http://socket.io">http://socket.io</a>.</p>

<p>Because you might want to have a bot that not only works on some arbitrary platform but also on your own webapp/app, support for socket.io was added to the Botmaster core. Although Socket.io enables developers to use their technology in a bunch of different applications, the fact that you want to use it in Botmaster means that you want to handle 1-1 conversations between users and your bot (managed by botmaster).</p>

<p>If you&rsquo;ve never used both botmaster and socket.io, It&rsquo;s probably still pretty unclear how all of this fits in together. Hopefully the next section will help you understand and get started with this.</p>

<h2 id="botmaster-socket-io-bot-mini-tutorial">Botmaster Socket.io bot mini-tutorial</h2>

<p>By following these steps, you will have a fully functional Socket.io bot using botmaster. The client will live in a tiny web-page. The point of this tutorial is to get you started so that you can develop it further in any way you wish. This is completely based on the socket.io web &ldquo;get started&rdquo; guide found here: <a href="http://socket.io/get-started/chat/">http://socket.io/get-started/chat/</a>.</p>

<h4 id="server-1">Server</h4>

<p>After making sure that we have a project folder with a node.js project initialised and the botmaster package in it as per the <a href="../../getting-started/installation">installation</a> guide.
We want to make sure botmaster is setup and make sure that messages coming from a websocket connection are received. So in our poject folder, in our <code>app.js</code> file, we simply copy the code found at the top of this page:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">const</span> <span class="nx">Botmaster</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;botmaster&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">botmaster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Botmaster</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">socketioSettings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;SOME_BOT_ID_OF_YOUR_CHOOSING&#39;</span><span class="p">,</span>
  <span class="nx">server</span><span class="o">:</span> <span class="nx">botmaster</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">socketioBot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Botmaster</span><span class="p">.</span><span class="nx">botTypes</span><span class="p">.</span><span class="nx">SocketioBot</span><span class="p">(</span><span class="nx">socketioSettings</span><span class="p">);</span>
<span class="nx">botmaster</span><span class="p">.</span><span class="nx">addBot</span><span class="p">(</span><span class="nx">socketioBot</span><span class="p">);</span>

<span class="nx">botmaster</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="s1">&#39;Right back at you&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>

<p>We will need to add a couple of lines to this code because we will be serving a webpage from our server. Not just listening on for botmaster messages. To do so, we take advantage of the fact that botmaster is built on top of express and that this app es exposed via <code>botmaster.app</code>. We also assume that we will be serving our static assets (the components of our webpage) from a folder called &lsquo;public&rsquo; within our project directory. Our updated code looks like this:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span> <span class="c1">//added</span>
<span class="kr">const</span> <span class="nx">Botmaster</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;botmaster&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">botmaster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Botmaster</span><span class="p">();</span>
<span class="nx">botmaster</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">__dirname</span><span class="si">}</span><span class="sb">/public`</span><span class="p">));</span> <span class="c1">//added</span>


<span class="kr">const</span> <span class="nx">socketioSettings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;SOME_BOT_ID_OF_YOUR_CHOOSING&#39;</span><span class="p">,</span>
  <span class="nx">server</span><span class="o">:</span> <span class="nx">botmaster</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">socketioBot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Botmaster</span><span class="p">.</span><span class="nx">botTypes</span><span class="p">.</span><span class="nx">SocketioBot</span><span class="p">(</span><span class="nx">socketioSettings</span><span class="p">);</span>
<span class="nx">botmaster</span><span class="p">.</span><span class="nx">addBot</span><span class="p">(</span><span class="nx">socketioBot</span><span class="p">);</span>

<span class="nx">botmaster</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="s1">&#39;Right back at you&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">botmaster</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>

<p>We also added the botmaster &lsquo;error&rsquo; event listener, because that&rsquo;s just always good to do.</p>

<h3 id="client-side">Client side</h3>

<p>As mentioned in the Server side, we will create a folder named &lsquo;public&rsquo; within our poject dir. In it, we will have the following three files:</p>

<ul>
<li>index.html</li>
<li>style.css</li>
<li>client_app.js</li>
</ul>

<p>So that your final tree structure looks like this:</p>

<pre><code>your_project_folder
├── app.js
└── public
    ├── client_app.js
    ├── index.html
    └── style.css
</code></pre>

<p>In the <code>index.html</code> file, we will put some very basic html that looks like this:</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Botmaster bot<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;style.css&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;chat&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;messages&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;form&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;text-input&quot;</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">&quot;off&quot;</span> <span class="p">/&gt;&lt;</span><span class="nt">button</span><span class="p">&gt;</span>Send<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;client_app.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>The important line here is the line where we are importing socket.io. This works because socket.io adds a path to our server (in this case, a server created by botmaster under the hood) to serve this exact endpoint.
The other imports are simply the ones we will be creating.</p>

<p>In the <code>style.css</code> file, simply add the following:</p>
<div class="highlight"><pre><code class="language-css" data-lang="css"><span></span><span class="o">*</span> <span class="p">{</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">box-sizing</span><span class="p">:</span>
  <span class="kc">border-box</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="k">font</span><span class="p">:</span> <span class="mi">13</span><span class="kt">px</span> <span class="n">Helvetica</span><span class="p">,</span> <span class="n">Arial</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span> <span class="p">{</span>
  <span class="k">background</span><span class="p">:</span> <span class="mh">#000</span><span class="p">;</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">fixed</span><span class="p">;</span>
  <span class="k">bottom</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span> <span class="nt">input</span> <span class="p">{</span>
  <span class="k">border</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">90</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">margin-right</span><span class="p">:</span> <span class="mf">.5</span><span class="kt">%</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span> <span class="nt">button</span> <span class="p">{</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">9</span><span class="kt">%</span><span class="p">;</span> <span class="k">background</span><span class="p">:</span> <span class="nb">rgb</span><span class="p">(</span><span class="mi">130</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
  <span class="k">border</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span> <span class="k">padding</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">#</span><span class="nn">messages</span> <span class="p">{</span>
  <span class="k">list-style-type</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">#</span><span class="nn">messages</span> <span class="nt">li</span> <span class="p">{</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">#</span><span class="nn">messages</span> <span class="p">.</span><span class="nc">botmaster-message</span> <span class="p">{</span>
  <span class="k">background</span><span class="p">:</span> <span class="mh">#eee</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>This is the exact look from the socket.io tutorial mentioned above (and mostly their code too).</p>

<p>Finally, in the <code>client_app.js</code> file, you should include the following:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// the following line could also be: &quot;var socket = io(&#39;ws://&lt;URL&gt;:&lt;PORT_Number&gt;?botmasterUserId=wantedUserId&#39;);&quot;</span>
<span class="c1">// if you know you will be communicating with a server different from the one that served you the page you are on.</span>
<span class="c1">// this only works because the socket.io library assumes with this syntax that the socket.io server</span>
<span class="c1">// lives at the same address as the server that served this page (this should mostly be your case)</span>
<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="s1">&#39;?botmasterUserId=wantedUserId&#39;</span><span class="p">);</span>

<span class="c1">// just get the html elements we will be needing by ID</span>
<span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">textInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;text-input&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">);</span>

<span class="nx">form</span><span class="p">.</span><span class="nx">onsubmit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// just making sure the page isn&#39;t refreshed</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="c1">// don&#39;t do anything if there is no text</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">textInput</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Add the user message to the web page</span>
  <span class="nx">messages</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span><span class="s1">&#39;beforeend&#39;</span><span class="p">,</span>
    <span class="sb">`&lt;li class=&quot;user-message&quot;&gt;</span><span class="si">${</span><span class="nx">textInput</span><span class="p">.</span><span class="nx">value</span><span class="si">}</span><span class="sb">&lt;/li&gt;`</span><span class="p">);</span>
  <span class="c1">// create a botmaster compatible message from the text input by the user</span>
  <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">text</span><span class="o">:</span> <span class="nx">textInput</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
  <span class="p">};</span>
  <span class="c1">// send the message over the webSocket</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="c1">// finally, clear the user textInput field</span>
  <span class="nx">textInput</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">botmasterMessage</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">textMessage</span> <span class="o">=</span> <span class="nx">botmasterMessage</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>

  <span class="nx">messages</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span><span class="s1">&#39;beforeend&#39;</span><span class="p">,</span>
    <span class="sb">`&lt;li class=&quot;botmaster-message&quot;&gt;</span><span class="si">${</span><span class="nx">textMessage</span><span class="si">}</span><span class="sb">&lt;/li&gt;`</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>

<p>You should have a read through this code to make sure you understand it as that is the code communicating with our botmaster backend.</p>

<p>On the first line, we call: <code>var socket = io('?botmasterUserId=wantedUserId');</code>. This effectively opens up a socket connection with our backend by making a request to something like this: <code>io('ws://localhost:3000?botmasterUserId=wantedUserId');</code>. Here as you can see, we are setting a query param called <strong>botmasterUserId</strong> to &ldquo;wantedUserId&rdquo;. This is done because we want to make sure that when we are getting updates in our backend, the <code>update.sender.id</code> part will be what we set it to here and not anything else (by default the randomly allocated socket.id value). This is even more important when your users can connect from different clients and you want to make sure the botmaster reply is propagated to all the clients.</p>

<p>In the <code>form.onsubmit</code> part, we make sure that the text contained in the input cell is correctly formatted then sent to botmaster via the websocket. We also make sure to display it in our page and to then clear the input.</p>

<p>In the <code>socket.on('message')</code> part, we simply display the received message.</p>

<p>Now that our code is here, simply go to your command line and run <code>node app.js</code>. If you now open a browser to 127.0.0.1:3000 you should be able to chat with your pretty useless (for now) bot. Just like this:</p>

<p><img src="../../images/socket.io_setup_1.png?width=90%" alt="Socket.io Setup 1" /></p>

<h2 id="security">Security</h2>

<p>You might be wondering how you can secure your Botmaster socket.io app. I.e. how can you make sure that a client connecting with a certain id really is who they claim they are. Well, this part is actually left to you, the developer to do. I didn&rsquo;t want to make any assumptions with regards to what people would want to use to secure their app. So what I do is expose the <code>socket.io</code> server object through the bot object. It can be accessed in the following way</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nx">socketioBot</span><span class="p">.</span><span class="nx">ioServer</span>
</code></pre></div>

<p>Then you&rsquo;ll be able to register a middleware function to your socker.io server as such:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nx">socketioBot</span><span class="p">.</span><span class="nx">ioServer</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
  <span class="nx">next</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Authentication error&#39;</span><span class="p">));</span>
<span class="p">});</span>
</code></pre></div>

<p>This is shamelessly stolen from the socket.io documentation here: <a href="http://socket.io/docs/server-api/#namespace#use(fn:function):namespace">http://socket.io/docs/server-api/#namespace#use(fn:function):namespace</a></p>

<p>This function will be executed every time there is an incoming socket connection. Indeed, no need to do so on every message as once the connection is made, all transfers are secured on the open socket. That&rsquo;s really the whole point of webSockets.</p>
</div>
    </div>
  </main>
  <script>
    function showNavMenu() {
      var sidebar = document.getElementById('sidebar')

      if (sidebar.className.indexOf('dn') !== -1) {
        sidebar.className = 'fl w-100 w-20-l pr2-l di-l'
      } else {
        sidebar.className = 'fl w-100 w-20-l pr2-l di-l dn'
      }
    }
  </script>
</body>

</html>

