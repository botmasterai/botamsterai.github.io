<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Botmaster | Writing your Own Bot Class</title>
  <link rel="stylesheet" href="../../css/tachyons.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link rel="stylesheet" href="../../css/notices.css" />
  <link rel="stylesheet" href="../../css/base16-tomorrow.light.css" />
</head>

<body>

<nav class="container center pa4 mb3">
  <div class="fl w-80 w-100-l">
    <a href="../../">
      <img class="v-mid" src="../../img/botmaster_light.svg" width="200" />
    </a>
  </div>
  <div class="fl w-20 tr dn-l f1 dusty-gray" onclick="showNavMenu()">
    &#9776;
  </div>
</nav>
<main class="container center">
  <div id="sidebar" class="fl w-100 w-20-l pr1-l dn di-l">
  <ul class="list mv2 ml4 ma2-l pa0">
    
      <h5 class="dusty-gray mt3 mb3 ttu">Documentation</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../documentation/botmaster/">
            Botmaster
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Getting Started</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/installation/">
            Installation
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/quickstart/">
            Quickstart
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/messenger-setup/">
            Messenger setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/slack-setup/">
            Slack setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/twitter-setup/">
            Twitter setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/telegram-setup/">
            Telegram setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/socketio-setup/">
            Socketio setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/webhooks/">
            Webhooks
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Working with Botmaster</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../working-with-botmaster/botmaster-basics/">
            Botmaster Basics
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../working-with-botmaster/middleware/">
            Middleware
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../working-with-botmaster/writing-your-own-bot-class/">
            Writing your own Bot Class
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Middlewares</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../middlewares/fulfill/">
            Fulfill
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Tutorials</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../tutorials/watson-conversation/">
            Watson Conversation
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Articles</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../articles/frameworks-comparison/">
            Frameworks comparison
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Updates</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../updates/changelog/">
            Changelog
          </a>
        </li>
      
    
  </ul>
</div>

  <div class="fl w-80-l w-100 pl2-l">
    <div class="bg-white br2 mt3">
      <div class="tc bg-black-pearl pv4 br--top2">
        <h1 class="fw5 white">Writing your Own Bot Class</h1>
      </div>
      <div class="pa4">

<h2 id="bot-classes">Bot classes</h2>

<p>The following document assumes that you have read the main documentation in &ldquo;getting started&rdquo; and in &ldquo;botmaster basics&rdquo;. A general understand of how Botmaster and more generally how chatbots work is also assumed.</p>

<p>Because of that, we will pick up right from there and start looking into the bot classes Botmaster comes bundled with.</p>

<p>Botmaster makes five usable bot classes available to developers out of the box. <code>MessengerBot</code>, <code>SlackBot</code>, <code>SocketioBot</code>, <code>TelegramBot</code> and <code>TwitterBot</code>.</p>

<p>For example, you can instantiate a new <code>MessengerBot</code> object as such:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">const</span> <span class="nx">Botmaster</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;botmaster&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">MessengerBot</span> <span class="o">=</span> <span class="nx">Botmaster</span><span class="p">.</span><span class="nx">botTypes</span><span class="p">.</span><span class="nx">MessengerBot</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">messengerSettings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">credentials</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">verifyToken</span><span class="o">:</span> <span class="s1">&#39;YOUR verifyToken&#39;</span><span class="p">,</span>
    <span class="nx">pageToken</span><span class="o">:</span> <span class="s1">&#39;YOUR pageToken&#39;</span><span class="p">,</span>
    <span class="nx">fbAppSecret</span><span class="o">:</span> <span class="s1">&#39;YOUR fbAppSecret&#39;</span>
  <span class="p">},</span>
  <span class="nx">webhookEndpoint</span><span class="o">:</span> <span class="s1">&#39;/webhook1234&#39;</span><span class="p">,</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">messengerBot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MessengerBot</span><span class="p">(</span><span class="nx">messengerSettings</span><span class="p">);</span>
</code></pre></div>

<p>In order to get updates from Messenger, you would then be expected to mount your bot&rsquo;s express mini-app <code>messengerBot.app</code> onto your own express <code>app</code> by doing something like this:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">messengerBot</span><span class="p">.</span><span class="nx">app</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3001</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
</code></pre></div>

<p>Or even better:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nx">messengerBot</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3001</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
</code></pre></div>

<p>This will mount your bot onto: <code>https://Your_Domain_Name:3001/webhook1234</code>. Note how the bot type <strong>is not</strong> part of the URL here.</p>

<h2 id="making-botmaster-objects-and-bot-objects-work-together">Making Botmaster objects and bot objects work together</h2>

<p>Doing this is really trivial and as it turns out, you do this every time you use the <code>addBot</code> method.</p>

<p>We recall from the various guides that to create a botmaster object the following is needed:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">const</span> <span class="nx">Botmaster</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;botmaster&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">botmaster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Botmaster</span><span class="p">();</span>
</code></pre></div>

<p>As usual, we create a botmaster object. This one supports Twitter and Telegram, but not Messenger. We create it as such:</p>

<p>In this example the <code>botmaster</code> object will start a new <code>express()</code> <code>app</code> server running locally on port <code>3000</code> as expected by default (see <a href="../../working-with-botmaster/botmaster-basics/#using-botmaster-with-your-own-express-app">here</a> to see how to change that).</p>

<p>As usual, we add the messenegrBot as follows:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nx">botmaster</span><span class="p">.</span><span class="nx">addBot</span><span class="p">(</span><span class="nx">messengerBot</span><span class="p">);</span>
</code></pre></div>

<p>This will mount your bot onto: <code>https://Your_Domain_Name:3000/messenger/webhook1234</code>. Note how the bot type <strong>is</strong> part of the endpoint here. This is because the Botmaster class assumes that you want your endpoint to be mounted onto its botType.</p>

<p>You will then get updates from the botmaster object as if you had instantiated it with the messenger settings too if your endpoint is setup properly.</p>

<div class="notices info" ><p>Please note, if you followed these steps and put all this code in one file. You will actually have two express servers running along side each other. One on port 3001 and one on port 3000. Both endpoints mentioned above would work. This is definitely not what you want to do in production. Pick one of the methods and stick to it in production.</p>
</div>


<p><strong>The main takeaway from all this is that any bot class that follows a  certain set of rules will be able to be added to a botmaster object.</strong></p>

<h2 id="creating-your-own-bot-classes">Creating your own bot classes</h2>

<p>Before defining the rules that have to be respected in order to write a Botmaster compatible bot class let&rsquo;s look at the constructor of one of the existing one, <code>TelegramBot</code>:</p>

<h3 id="constructor-settings"><code>#constructor(settings)</code></h3>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">class</span> <span class="nx">TelegramBot</span> <span class="kr">extends</span> <span class="nx">BaseBot</span> <span class="p">{</span>

  <span class="nx">constructor</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;telegram&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">requiresWebhook</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">requiredCredentials</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;authToken&#39;</span><span class="p">];</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">__applySettings</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
    <span class="p">.</span>
    <span class="p">.</span>
    <span class="p">.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">__createMountPoints</span><span class="p">();</span>
  <span class="p">}</span>

 <span class="p">}</span>
</code></pre></div>

<p>Let&rsquo;s look into this line by line. The first line reads <code>super(settings)</code>. Which of course just means it calls the constructor of <code>TelegramBot</code>&rsquo;s superclass, namely, <code>BaseBot</code>. <code>BaseBot</code>&rsquo;s constructor doesn&rsquo;t actually do anything fancy a part from calling its own superclass&rsquo;s constructor and setting a few default values [as pointers for you, the developer]. BaseBot calls its own superclass&rsquo;s constructor as it inherits from node.js&rsquo;s <code>EventEmitter</code> which will allow your bot&rsquo;s classes to listen to events as well as emit them.</p>

<p>The following three lines setup some important values.</p>

<ol>
<li><code>this.type</code>: the type of bot that is being instantiated. It&rsquo;s important to specify that as developers might want to condition some code on the type of bot you are writing.</li>
<li><code>this.requiresWebhook</code>: whether the bot requires webhooks. If the platform you are coding for requires webhooks, you will be expected to set a <code>this.app</code> variable at some point in the setup. We&rsquo;ll look into this when we have a look at what the <code>this.__createMountPoints();</code> does.</li>
<li><code>this.requiredCredentials</code>: sets up an array of credentials that are expected to be defined for the platform you are coding your class for. Telegram only takes in 1, so we just have an array with the value <code>'authToken'</code>.</li>
</ol>

<h3 id="applysettings-settings"><code>#__applySettings(settings)</code></h3>

<p>The next line calls the <code>this.__applySettings(settings)</code> function. This function is implemented in BaseBot and will just make sure that the settings passed on to the bot constructor are valid with respect to the parameters you defined. You should always call this function directly after setting the three [or more or less depending on your bot] parameters specific to the platform you are coding for. If valid, the settings will then be applied to the bot object. e.g. <code>this.webhookEndpoint</code> will be set to <code>settings.webhookEndpoint</code>.</p>

<h3 id="createmountpoints"><code>#__createMountPoints()</code></h3>

<p>The last line of our controller makes a call to <code>this.__createMountPoints();</code>. This line should only be present if your bot class requires webhooks. If this is the case, you will be expected to define a class member function that looks something like:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span>  <span class="nx">__createMountPoints</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
    <span class="c1">// for parsing application/json</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
    <span class="c1">// for parsing application/x-www-form-urlencoded</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span> <span class="nx">extended</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">webhookEndpoint</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">__formatUpdate</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>

      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">update</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">__emitUpdate</span><span class="p">(</span><span class="nx">update</span><span class="p">);</span>
      <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="sb">`Error in __formatUpdate &quot;</span><span class="si">${</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">&quot;. Please report this.`</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="c1">// just letting telegram know we got the update</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">sendStatus</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div>

<p>Very importantly, this function creates an express router <code>this.app</code> that will be mounted onto the main <code>app</code> router from the botmaster object if <code>botmaster.addBot</code> is used.</p>

<p>It then sets up the post endpoint that listens onto <code>this.webhookEnpoint</code>. No further assumption is made here.</p>

<p>Please note that you might have another function that needs to be called at this point. For instance, in the <code>socketioBot</code> class, I make a call to: <code>this.__setupSocketioServer();</code> and that function looks like this:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nx">__setupSocketioServer</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ioServer</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">ioServer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">SocketioBot</span><span class="p">.</span><span class="nx">__getBotmasteruserId</span><span class="p">(</span><span class="nx">socket</span><span class="p">));</span>

    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// just broadcast the message to other connected clients with same user id</span>
      <span class="kr">const</span> <span class="nx">botmasterUserId</span> <span class="o">=</span> <span class="nx">SocketioBot</span><span class="p">.</span><span class="nx">__getBotmasteruserId</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">botmasterUserId</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;own message&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
      <span class="c1">// console.log(JSON.stringify(socket.rooms, null, 2));</span>
      <span class="kr">const</span> <span class="nx">rawUpdate</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">rawUpdate</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="sb">`ERROR: &quot;Expected JSON object but got &#39;</span><span class="si">${</span><span class="k">typeof</span> <span class="nx">message</span><span class="si">}</span><span class="sb">&#39; </span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb"> instead&quot;`</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kr">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__formatUpdate</span><span class="p">(</span><span class="nx">rawUpdate</span><span class="p">,</span> <span class="nx">botmasterUserId</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__emitUpdate</span><span class="p">(</span><span class="nx">update</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p>Feel free to have a thorough read at this to understand what is going on here. Because it isn&rsquo;t necessary to understand this in order to build your own bot class, I won&rsquo;t explain what is going on here.</p>

<h3 id="formatupdate-rawupdate"><code>#__formatUpdate(rawUpdate)</code></h3>

<p>Although you can technically handle the body of the request as you wish. In our <code>__createMountPoints</code> example here (from TelegramBot code), we make a call to the <code>__formatUpdate</code> function with the body of the request.
It would make sense for you to do so for consistency and because it has to be defined if you want your bot class to eventually be referenced in the Botmaster project.</p>

<p>This function is expected to transform the <code>rawUpdate</code> into an object which is of the format of Messenger updates, while having an <code>update.raw</code> bit that references that <code>rawUpdate</code> received.</p>

<p>Typically, it would look something like this for a message with an image attachment. Independent of what platform the message comes from:</p>

<pre><code>{
  raw: &lt;platform_specific_raw_update&gt;,
  sender: {
    id: &lt;id_of_sender&gt;
  },
  recipient: {
    id: &lt;id_of_the_recipent&gt; // will typically be the bot's id
  },
  timestamp: &lt;unix_miliseconds_timestamp&gt;,
  message: {
    mid: &lt;message_id&gt;,
    seq: &lt;message_sequence_id&gt;,
    attachments: [
      {
        type: 'image',
        payload: {
          url: 'SOME_IMAGE_URL'
        }
      }
    ]
  }
};
</code></pre>

<p>Your function should return the update object(or a promise that resolves a formatted update object) in order to then call <code>__emitUpdate</code> with it as a parameter.</p>

<h3 id="emitupdate-update"><code>#__emitUpdate(update)</code></h3>

<p>Like <code>__applySettings</code>, this method is implemented in <code>BaseBot</code>. It handles errors, calling the <code>incoming</code> middleware stack, and most importantly, actually calling <code>this.emit(update)</code> to emit the actual update. You can overwrite this method if you wish, but in its current state, it handles the most important cases you will want to deal with. You should call this method with the formatted <code>update</code> object created by calling <code>formatUpdate()</code>;</p>

<h3 id="sendmessage-message"><code>#__sendMessage(message)</code></h3>

<p>All previous methods had either something to do with object instantiation or with incoming messages. We&rsquo;ll now have a look at what needs to be done within your bot class to send messages.</p>

<p>The <code>__sendMessage</code> method needs to be implemented. The method should take in a Messenger style message and send a formatted message to the bot platform. It should return a <code>Promise</code> that resolves to something like this:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span>  <span class="p">{</span>
   <span class="nx">raw</span><span class="o">:</span> <span class="nx">rawBody</span><span class="p">,</span>
   <span class="nx">recipient_id</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">id_of_user</span><span class="o">&gt;</span><span class="p">,</span>
   <span class="nx">message_id</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">message_id_of_what_was_just_sent</span><span class="o">&gt;</span>
  <span class="p">}</span>
</code></pre></div>

<p>Code for it might look like this simplified one from <code>TelegramBot</code>:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span> <span class="nx">__sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;https://api.telegram.org/sendMessage&#39;</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
  <span class="p">};</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__formatOutgoingMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="c1">// using request-promise package and not request here</span>

  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">body</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">error</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">standardizedBody</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">raw</span><span class="o">:</span> <span class="nx">body</span><span class="p">,</span>
      <span class="nx">recipient_id</span><span class="o">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="c1">// this is really the equivalent to a Messenger seq.</span>
      <span class="c1">// But it&#39;s either that or null for telegram</span>
      <span class="nx">message_id</span><span class="o">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">message_id</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">standardizedBody</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p>See how we are returning a promise that resolves to an object as specified above!</p>

<p>It is important to note that this be a promise and not a callback. Although developers using Botmaster can use <code>sendMessage</code> type methods with callbacks. The internals of Botmaster use Promises and therefore, so should your bot class.</p>

<p>Please note that the <code>BaseBot</code> superclass defines a set of methods that allow developers to more easily send messages to all platforms without having to build the whole Messenger compatible object themselves. These methods are the following:</p>

<p><code>sendMessage</code>
<code>sendMessageTo</code>
<code>sendTextMessageTo</code>
<code>reply</code>
<code>sendAttachmentTo</code>
<code>sendAttachmentFromURLTo</code>
<code>sendDefaultButtonMessageTo</code>
<code>sendIsTypingMessageTo</code>
<code>sendCascadeTo</code>
<code>sendTextCascadeTo</code></p>

<p>All these methods will convert a developer specified input into a Facebook Messenger compatible message that will be called as a parameter to <code>__sendMessage</code>. That is, they all eventually will call your <code>__sendMessage</code> method. You can however overwrite them if need be.</p>

<h3 id="formatoutgoingmessage-message"><code>#__formatOutgoingMessage(message)</code></h3>

<p>Your <code>sendMessage</code> method is expected to call a <code>__formatOutgoingMessage(message)</code> method that will format the Messenger style message into one that is compatible with the platform you are coding your bot class for.</p>

<p>You can have a look at the ones defined in the <code>TelegramBot</code> and the <code>TwitterBot</code> classes for inspiration.</p>

<h3 id="setbotidifnotset-update"><code>#__setBotIdIfNotSet(update)</code></h3>

<p>In order to help you identify between bots of different types, you will want each bot instance to have a <code>this.id</code> value. This should typically be the same as <code>update.recipient.id</code> when getting updates. If these aren&rsquo;t set upon instantiation (as with Facebook Messenger bots), you can write a function like this <code>MessengerBot</code> one that gets called upon receiving a message.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="nx">__setBotIdIfNotSet</span><span class="p">(</span><span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  	<span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">update</span><span class="p">.</span><span class="nx">recipient</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="is-this-really-all-there-is-to-it">Is this really all there is to it?</h2>

<p>Yes it is! These few basic steps are the steps that should be followed in order to build your own bot classes. Nothing more is required. Of course, formatting the incoming updates and the outgoing messages won&rsquo;t always be as trivial as we&rsquo;d wish, but this guide should help you into doing this.</p>
</div>
    </div>
  </main>
  <script>
    function showNavMenu() {
      var sidebar = document.getElementById('sidebar')

      if (sidebar.className.indexOf('dn') !== -1) {
        sidebar.className = 'fl w-100 w-20-l pr2-l di-l'
      } else {
        sidebar.className = 'fl w-100 w-20-l pr2-l di-l dn'
      }
    }
  </script>
</body>

</html>

