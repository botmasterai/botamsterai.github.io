<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  
  <link rel="shortcut icon" href="../../images/favicon.ico" type="image/x-icon" />

  <title>Botmaster | Using Botmaster Fulfill Middleware</title>
  <link rel="stylesheet" href="../../css/tachyons.css" />
  <link rel="stylesheet" href="../../css/main.css" />
  <link rel="stylesheet" href="../../css/notices.css" />
  <link rel="stylesheet" href="../../css/base16-tomorrow.light.css" />
  <link href="../../css/botmaster_style.css" rel="stylesheet">

</head>

<body>

<nav class="container center pa4 mb3">
  <div class="fl w-80 w-100-l">
    <a href="../../">
      <img class="v-mid" src="../../img/botmaster_light.svg" width="200" />
    </a>
  </div>
  <div class="fl w-20 tr dn-l f1 dusty-gray" onclick="showNavMenu()">
    &#9776;
  </div>
</nav>
<main class="container center">
  <div id="sidebar" class="fl w-100 w-20-l pr1-l dn di-l">
  <ul class="list mv2 ml4 ma2-l pa0">
    
      <h5 class="dusty-gray mt3 mb3 ttu">Documentation</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../documentation/botmaster/">
            Botmaster
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Getting Started</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/installation/">
            Installation
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/quickstart/">
            Quickstart
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/messenger-setup/">
            Messenger setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/slack-setup/">
            Slack setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/twitter-setup/">
            Twitter setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/telegram-setup/">
            Telegram setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/socketio-setup/">
            Socketio setup
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../getting-started/webhooks/">
            Webhooks
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Working with Botmaster</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../working-with-botmaster/botmaster-basics/">
            Botmaster Basics
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../working-with-botmaster/middleware/">
            Middleware
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../working-with-botmaster/writing-your-own-bot-class/">
            Writing your own Bot Class
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Middlewares</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../middlewares/official-middleware/">
            Official Middleware
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../middlewares/fulfill/">
            Fulfill
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Tutorials</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../tutorials/watson-conversation/">
            Watson Conversation
          </a>
        </li>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../tutorials/using-fulfill/">
            Using Fulfill
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Articles</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../articles/frameworks-comparison/">
            Frameworks comparison
          </a>
        </li>
      
    
      <h5 class="dusty-gray mt3 mb3 ttu">Updates</h5>
      
        <li class="mb2">
          <a class="no-underline cerulean-blue" href="../../updates/changelog/">
            Changelog
          </a>
        </li>
      
    
  </ul>
</div>

  <div class="fl w-80-l w-100 pl2-l">
    <div class="bg-white br2 mt3">
      <div class="tc bg-black-pearl pv4 br--top2">
        <h1 class="fw5 white">Using Botmaster Fulfill Middleware</h1>
      </div>
      <div class="pa4">

<h1 id="using-botmaster-fulfill-middleware">Using Botmaster Fulfill middleware</h1>

<p>Although many of you will be using Botmaster because of its ability to connect with message sources like Facebook Messenger, it also has a powerful middleware called Botmaster Fulfill. Fulfill helps helps greatly with building more sophisticated bots that need integrations with external data sources and more complex logic. It&rsquo;s task is to provide a framework for addressing tasks that are outside of the scope of a core NLU or AI engine, so it&rsquo;s complementary to something like Watson Conversation or Wit.ai.</p>

<h2 id="what-can-i-do-with-botmaster-fulfill">What can I do with Botmaster Fulfill?</h2>

<p>You hopefully want to wow your bot&rsquo;s users with some high-end functionality that gets them hooked on using a conversational interface to get stuff done. If so, you will need to rely on more than pre-canned static replies held within your AI engine â€“ such bots can get pretty boring quite quickly.</p>

<p>Connecting your bot to more dynamic and real-time sources of information is probably high on your priority list. In addition, taking advantage of UI features like buttons and location awareness, might also be things you are interested in. These are the kind of things that Botmaster Fulfill can help with.</p>

<p>To get specific, here is a set of things that you might use Botmaster Fulfill for:</p>

<ul>
<li>Specifying where various types of buttons might be used within the conversation to guide the user&rsquo;s response.</li>
<li>Specifying how a longer conversational response should be broken into a series of shorter messages that appear one-after-the-other in the user&rsquo;s messaging app, just like we tend to do when texting a friend.</li>
<li>Calling external API services and integrating the results into the conversation, for example adding a stock quote or weather forecast. Or a call to your organisation&rsquo;s core systems to retrieve a customer order or balance.</li>
<li>Initiating transactions such as placing an order or making a payment.</li>
<li>Making a time-of-day specific greetings (Good morning, Good afternoon, Good evening, etc).</li>
</ul>

<p>In short, anything you need your bot to do that your AI doesn&rsquo;t, is probably a candidate for Botmast Fulfill.</p>

<h2 id="why-should-i-use-botmaster-fulfill">Why should I use Botmaster Fulfill?</h2>

<p>&ldquo;Separation of concerns&rdquo; is generally considered a good thing. It turns out that in bot design, it&rsquo;s an especially good thing. Why do we say that?</p>

<p>Designing your conversational flow and how your bot responds to questions is an analyst-type job - you need people good at understanding the problem domain and how to craft a great conversations. You these people to have a nice life, unencumbered by any technical complexities.</p>

<p>If your bot needs to invoke programming logic, for example to call an external API and include the results into the bot&rsquo;s response, you surely want to keep that programming away from your conversational analysts.</p>

<p>However, before Botmaster Fulfill it was tricky to keep your conversational design totally separate from your integration logic. Or sometimes you ended up with small pieces of logic buried in your conversational flow who flagged things to some external integration logic - which is basically unmaintainable in the long term.</p>

<p>Botmaster Fulfill solves these problems by providing a clean separation of concerns. With it, conversational analysts use simple XML tags to markup a bot&rsquo;s responses. Those tags are interpreted by a series of javascript modules that implement the logic needed. The conversational analyst gets to specify when logic should be called and the engineer gets to separately specify how that logic is implemented&hellip;.and we achieve a separation of concerns.</p>

<h2 id="how-do-i-use-fulfill-in-my-conversational-flow">How do I use Fulfill in my conversational flow?</h2>

<p>The beauty of Botmaster Fulfill is that complex logic can be specified by including very simple XML tags within a bot&rsquo;s response text. For example, in the following dialog response the</p>

<p><weather> tag is identified by Botmaster Fulfill and replaced with the result of an API call to a weather forecast service.
<code>I thought you might like a weather forecaset, so here it is: &lt;weather /&gt;</code></weather></p>

<p>What is super nice here, is that your dialog designer doesn&rsquo;t need to worry about how the weather API works or indeed how to get the result of that API call into her conversational response. That&rsquo;s the engineer&rsquo;s job - which we will come to shortly.</p>

<p>Here&rsquo;s another, more complex, example:</p>

<pre><code>&lt;greet /&gt;&lt;pause /&gt;How are you today?&lt;buttons&gt;Good,Bad,Indifferent&lt;/buttons&gt;
</code></pre>

<p>This results in two separate messages being sent:</p>

<ol>
<li>A message that&rsquo;s reflective of the time of day, such as &ldquo;Good morning!&rdquo; or &ldquo;Good afternoon.&rdquo;</li>
<li>A second message &ldquo;How are you today?&rdquo; with three quick-reply buttons Good, Bad, Indifferent.</li>
</ol>

<p>As you can hopefully see, multiple XML tags can be included within the same response, building some quite sophisticated responses and integrations. It&rsquo;s super-simple for the conversational analyst to specify these tags and the programming logic to implement them is totally separated.</p>

<h2 id="sounds-great-how-do-i-get-started">Sounds great, how do I get started?</h2>

<p>The implementation of the logic needed to fulfill these XML tags is through what we call a Botmaster Fulfill action. These actions are really just standard javascript code, so any half-decent node coder should be able to get to grips with things pretty quickly.</p>

<p>But to get us going, we&rsquo;re first going to use some pre-defined Botmaster Fulfill actions. We&rsquo;ll move on to making our own custom actions in the next step.</p>

<p>First of all install Botmaster Fulfill using: <code>npm install botmaster-fulfill -S</code></p>

<p>Then, install the pre-defined Botmaster Fulfill actions using: <code>npm install botmaster-fulfill-actions -S</code></p>

<p>Now add the following code to your Botmaster <code>app.js</code> file:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kr">const</span> <span class="p">{</span><span class="nx">fulfillOutgoingWare</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;botmaster-fulfill&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">actions</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;botmaster-fulfill-actions&#39;</span><span class="p">);</span>
<span class="nx">botmaster</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;outgoing&#39;</span><span class="p">,</span> <span class="nx">fulfillOutgoingWare</span><span class="p">({</span>
  <span class="nx">actions</span>
<span class="p">}));</span>
</code></pre></div>

<p>Now we&rsquo;re ready to go! At the time of writing, the standard actions include:</p>

<ul>
<li><code>&lt;pause /&gt;</code> - which breaks the message into two separate messages, one from each side of the pause tag.</li>
<li><code>&lt;greet tz=&quot;Europe/London&quot; /&gt;</code> - which returns a location/language relevant greeting such as &ldquo;Good morning&rdquo; or &ldquo;Good evening&rdquo;, depending on the time of day and the timezone/location specified.</li>
</ul>

<p>Go ahead and try these out by adding something like the following as a response in whatever dialoging engine you are using: <code>&lt;greet /&gt;&lt;pause /&gt;How are you today?</code></p>

<p>If you haven&rsquo;t wired up an AI engine yet, you could just add the following code to your app.js file. If you do that, it doesn&rsquo;t matter what you type into your bot, you&rsquo;ll get the same answer - but it does the job of exercising Botmaster Fulfill and its standard actions.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">botmaster</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="s1">&#39;&lt;greet /&gt;&lt;pause /&gt;How are you today?&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>

<p>How cool is that?! The Botmaster project is hoping to expand this set of standard actions, so keep an eye on the Github repo.</p>

<h2 id="but-how-do-i-write-my-own-botmaster-fulfill-actions">But how do I write my own Botmaster Fulfill actions?</h2>

<p>As we discussed earlier, Botmaster Fulfill actions are just javascript â€“ so, as you&rsquo;re already using Botmaster, you will already be at least vaguely competent at this task. It&rsquo;s OK if you&rsquo;re still at the vague end of the competency spectrum - you can write simple Actions with very basic knowledge.</p>

<p>Lets start off by modifying our above code with a super-simple custom action. To do this, we define our custom action by adding the following code after the definition of standardActions in the <code>app.js</code> we used in the last step.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kr">const</span> <span class="nx">checkUserState</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">controller</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;How are you today?&#39;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>This is pretty self-explanatory â€“ checkUserState is the name of the XML tag this code implements. The variable <code>params</code> is just a placeholder for whatever text might be between the open and closing XML tags. In our case this will be empty, because we have a single open/close tag. We return a Javascript Promise that resoles to &ldquo;How are you today?&rdquo;, the text that replaces our checkUserState tag in the bot&rsquo;s reply. Returning a Promise means our code is executed asynchronously - which is pretty handy if you&rsquo;re calling an external API, for example.</p>

<p>Next, we need to modify our <code>botmaster.use</code> statement to include <code>checkUserState</code> as follows:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">actions</span><span class="p">.</span><span class="nx">checkUserState</span> <span class="o">=</span> <span class="nx">checkUserState</span><span class="p">;</span>
<span class="nx">botmaster</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;outgoing&#39;</span><span class="p">,</span> <span class="nx">fulfillOutgoingWare</span><span class="p">({</span>
  <span class="nx">actions</span>
<span class="p">}));</span>
</code></pre></div>

<p>And change our bot reply text to something like the following: <code>&lt;greet /&gt;&lt;pause /&gt;&lt;checkUserState /&gt;</code></p>

<p>Now this might not be the best of example - it&rsquo;s a bit overkill to implement a simple question as a Fulfill Action. However, it&rsquo;s often good to start with something basic so as not to overwhelm ourselves. And &ldquo;Hello World&rdquo; has become a bit too ubiquitous for my liking.</p>

<h2 id="using-fulfill-to-create-quick-reply-buttons">Using Fulfill to create Quick Reply Buttons</h2>

<p>As we&rsquo;ve asked a question at this point, wouldn&rsquo;t it be kind of cool if we provided a <code>Yes</code> and <code>No</code> Quick Reply button as a response? Luckily this is pretty easy to do with Botmaster&rsquo;s Quick Reply functionality in partnership with Botmaster Fulfill.</p>

<p>To do this we can add the following Botmaster Fulfill action for buttons:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">buttons</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">controller</span><span class="o">:</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="kr">const</span> <span class="nx">buttonTitles</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">);</span>
     <span class="nx">params</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">quick_replies</span> <span class="o">=</span> <span class="p">[];</span>
     <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">buttonTitle</span> <span class="k">of</span> <span class="nx">buttonTitles</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">params</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">quick_replies</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
         <span class="nx">content_type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
         <span class="nx">title</span><span class="o">:</span> <span class="nx">buttonTitle</span><span class="p">,</span>
         <span class="nx">payload</span><span class="o">:</span> <span class="nx">buttonTitle</span><span class="p">,</span>
       <span class="p">});</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>And update our reply to be: <code>&lt;helloWorld /&gt;&lt;pause /&gt;&lt;checkUserState /&gt;&lt;buttons&gt;Yes|No&lt;/buttons&gt;</code></p>

<p>Do you see what we&rsquo;re doing here? The button titles are included between the opening/closing</p>

<p><buttons> tags and separated by â€œ|â€œ. Our controller receives this in the <code>paramas</code> object and splits its contents apart to create a Botmaster quick replies array. You can hopefully see how you might use the same principle to create other types of Botmaster reply objects.</buttons></p>

<h2 id="finding-the-user-s-location">Finding the user&rsquo;s location</h2>

<p>If the user is using Facebook Messenger, we can extend the above example to generate a special button asking for the user&rsquo;s location, which results in us receiving the user&rsquo;s latitude/longitude.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">locButton</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">controller</span><span class="o">:</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="nx">params</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">quick_replies</span> <span class="o">=</span> <span class="p">[];</span>
     <span class="nx">params</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">quick_replies</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">content_type</span><span class="o">:</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span>
     <span class="p">});</span>
     <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>and change the returned text to:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">botmaster</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span> <span class="o">!=</span> <span class="p">(</span><span class="s1">&#39;Good&#39;</span> <span class="o">||</span> <span class="s1">&#39;Bad&#39;</span> <span class="o">||</span> <span class="s1">&#39;Indifferent&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="s1">&#39;&lt;greet tz=&quot;Europe/London&quot; /&gt; &lt;userName /&gt;&lt;pause /&gt;How are you today?&lt;pause /&gt;&lt;buttons&gt;Good,Bad,Indifferent&lt;/buttons&gt;&#39;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="s1">&#39;OK. It would be interesting to know where you are.&lt;pause /&gt;&lt;locButton /&gt;&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>

<p>So now we have a message returned to us that has the user&rsquo;s location embedded within in it. How about we use that latitude/longitude to get a weather forecast using a Fulfill action and return that to the user?</p>

<h2 id="calling-an-external-api-in-a-fulfill-action">Calling an external API in a Fulfill Action</h2>

<p>So far our examples have been quite trivial. But Fulfill can do some pretty sophisticated things. One thing we find particularly useful is the ability to call an external API and integrate it&rsquo;s results into the conversational response.</p>

<p>For this exercise we&rsquo;re going to integrate the results of a weather forecast API call into our bot&rsquo;s response.</p>

<p>Here&rsquo;s the function that calls the weather API service. You&rsquo;ll need to register <a href="https://console.ng.bluemix.net/catalog/services/weather-company-data/">here</a> in Bluemix and provide the required userID and password fields to make it work.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">getWeather</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">lat</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kr">const</span> <span class="kr">long</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kr">const</span> <span class="nx">requestOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;https://twcservice.mybluemix.net/api/weather/v1/geocode/&#39;</span> <span class="o">+</span> <span class="nx">lat</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="kr">long</span> <span class="o">+</span> <span class="s1">&#39;/forecast/daily/3day.json?language=en-US&amp;units=e&#39;</span><span class="p">,</span>
    <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">user</span><span class="o">:</span> <span class="s1">&#39;[enter user-id here]&#39;</span><span class="p">,</span>
      <span class="nx">pass</span><span class="o">:</span> <span class="s1">&#39;[enter password here]&#39;</span><span class="p">,</span>
      <span class="nx">sendImmediately</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="nx">json</span><span class="o">:</span> <span class="kc">true</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">requestOptions</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">body</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">body</span><span class="p">.</span><span class="nx">forecasts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">narrative</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>And here&rsquo;s our weather Action definition:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">weather</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">controller</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">return</span> <span class="nx">getWeather</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
       <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
          <span class="k">return</span> <span class="s1">&#39;I thought you might like a weather forecast for that location.&lt;pause /&gt;&#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">;</span>
        <span class="p">})</span>
       <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
         <span class="k">return</span> <span class="s1">&#39;Sorry, no weather forecast available at the moment.&#39;</span><span class="p">;</span>
       <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>If we update our bot message return logic to the following, we should be able to get a weather forecast sent back to the user when they click on one of the Good, Bad, Indifferent buttons:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">botmaster</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">attachments</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;location&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">lat</span> <span class="o">=</span> <span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">payload</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">.</span><span class="nx">lat</span><span class="p">;</span>
      <span class="kr">const</span> <span class="kr">long</span> <span class="o">=</span> <span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">payload</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">.</span><span class="kr">long</span><span class="p">;</span>
      <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="s1">&#39;&lt;weather&gt;&#39;</span> <span class="o">+</span> <span class="nx">lat</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="kr">long</span> <span class="o">+</span> <span class="s1">&#39;&lt;/weather&gt;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">update</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span> <span class="o">!=</span> <span class="p">(</span><span class="s1">&#39;Good&#39;</span> <span class="o">||</span> <span class="s1">&#39;Bad&#39;</span> <span class="o">||</span> <span class="s1">&#39;Indifferent&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="s1">&#39;&lt;greet tz=&quot;Europe/London&quot; /&gt; &lt;userName /&gt;&lt;pause /&gt;How are you today?&lt;pause /&gt;&lt;buttons&gt;Good,Bad,Indifferent&lt;/buttons&gt;&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">bot</span><span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span> <span class="s1">&#39;OK. It would be interesting to know where you are.&lt;pause /&gt;&lt;locButton /&gt;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>

<p>So there you have it. Using Botmaster Fulfill to execute standard actions that generate a greeting and break messages up. Using Botmaster Fulfill to generate quick reply buttons, get the user&rsquo;s location and then call an external weather forecast API. Hopefully your scenario is similar to at least one of these examples and you can find a way of using Fulfill to separate the concerns of your developer and conversational analyst.</p>

<!--
If you want to just skip to a working version of this tutorial, just download [this](app.js) pre-built `app.js` file.
-->

<p>If you&rsquo;re inspired by this tutorial to develop your own actions, please consider submitting them to the Botmaster community through a <code>Pull</code> request. We want to foster the development of a library of these functions to simplify everyone&rsquo;s jobs - and you can help!</p>
</div>
    </div>
  </main>
  <script>
    function showNavMenu() {
      var sidebar = document.getElementById('sidebar')

      if (sidebar.className.indexOf('dn') !== -1) {
        sidebar.className = 'fl w-100 w-20-l pr2-l di-l'
      } else {
        sidebar.className = 'fl w-100 w-20-l pr2-l di-l dn'
      }
    }
  </script>
</body>

</html>

